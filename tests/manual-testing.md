# Manual Testing

This documents some use cases and stesps for manually testing the CLI when major
things change, such as upgrading the backend, to make sure that things
are fully-operational. The hope here is to automate these steps into integration
tests when time allows.

## Preconditions for all tests

Before running these tests, the following conditions must be met:

1. You must have an AWS account configured with *us-east-1* as the default 
region. It is best to run a few commands to make sure everything is 
configured properly:

        $ aws configure list
        Name                    Value             Type    Location
        ----                    -----             ----    --------
        profile                <not set>             None    None
        access_key     ****************NXAW shared-credentials-file    
        secret_key     ****************ymwP shared-credentials-file    
        region                us-east-1      config-file    ~/.aws/config

1. Make sure you have an *additional* AWS account that can be used to
be an account in the pool. ***Make sure this is not a production account,
as AWS Nuke will run in the account and wipe all the resources!***

1. Run `aws sts get-caller-identity` just to verify the account number
that you have configured as your default. You really don't want to 
deploy DCE to an un-planned account.

1. It is a good idea to make sure there aren't a bunch of resources
in your account in which you are testing the DCE deployment. Ideally,
it should be a completely empty acccount.

## Required tools

To run these tests, you will need the following tools:

1. [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html)
1. [HTTPie](https://httpie.org/) - for testing API calls
1. [httpie-aws-authv4](https://github.com/aidan-/httpie-aws-authv4) - for calling
the API with the AWS credentials

# UC1: Deployment and basic smoke testing

1. Make sure the `~/.dce` directory does **not** already exist, as this
will skew your results. If you have the directory and would like to keep
it, back it up and then remove the original.
1. With the `~/.dce` directory removed, re-run the `dce init` command
to create a new blank file:

        $ dce init
        <hit return through prompts>

1. When finished, view the ~/.dce/config.yaml` file to make sure that it was
property created. The file should look like this, with most of the lines blank:

        $ cat ~/.dce/config.yaml
        api:
          host: 
          basepath: 
        region: us-east-1
        terraform:
          bin: null
          source: null

1. Now you can deploy. In your clean AWS account, type the following command:

        $ dce system deploy
        Initializing
        Do you really want to create DCE resources in your AWS account? (type "yes" or "no")yes
        Creating DCE infrastructure
        Retrieving artifacts location
        Artifacts bucket =  123456789012-dce-artifacts-dce-ffa500
        Deploying code assets to DCE infrastructure
        Downloading DCE code assets
        .
        .
        .
        .
        .
        .
        .
        .
        .
        .
        .
        .
        Updating AWS Lambda functions...
        Finished updating AWS Lambda functions.

1. Take note of the *namespace*, which is automatically generated by the
CLI during deployment. In the case above, it is `ffa500`. You can use
that namespace to identify many, but not all, of the DCE resources.

1. After the command is finished, the configuration file should be updated 
 with the URL of the API as well as the terraform source location and the 
location on the filesystem. Re-look at the file, and it should look something
like this:

        $ cat ~/.dce/config.yaml
        api:
          host: 0the0je5x8.execute-api.us-east-1.amazonaws.com
          basepath: /api
        region: us-east-1
        terraform:
          bin: /Users/uexample/.dce/.cache/terraform/0.12.18/terraform
           source: https://releases.hashicorp.com/terraform/0.12.18/terraform_0.12.18_darwin_amd64.zip


1. At this point, DCE should be deployed in your account. You can verify
this by running a couple commands. For once, there should a number of 
AWS Lambda functions in your account that weren't there before:

        $ aws lambda list-functions --query "Functions[*].FunctionName"
        [
            "account_pool_metrics-dce-o05cdj7l",
            "leases-dce-o05cdj7l",
            "process_reset_queue-dce-o05cdj7l",
            "populate_reset_queue-dce-o05cdj7l",
            "accounts-dce-o05cdj7l",
            "fan_out_update_lease_status-dce-o05cdj7l",
            "update_lease_status-dce-o05cdj7l",
            "usage-dce-o05cdj7l",
            "lease_auth-dce-o05cdj7l",
            "update_principal_policy-dce-o05cdj7l",
            "credentials_web_page-dce-o05cdj7l"
        ]

1. You should see an REST API using the following command:

        $ aws apigateway get-rest-apis --query "items[*].name"
        [
            "dce-dce-o05cdj7l"
        ]

1. With the HTTPS URL for the API, you should be able to call the API
with your AWS credentials. To test the API directly after installing, use
the URL from the `~/.dce/config.yaml` file and run the command as shown 
here:

        $ http -A aws4 https://0the0je5x8.execute-api.us-east-1.amazonaws.com/api/accounts

        HTTP/1.1 200 OK
        Access-Control-Allow-Origin: *
        Connection: keep-alive
        Content-Length: 3
        Content-Type: application/json
        Date: Wed, 01 Apr 2020 15:48:48 GMT
        Via: 1.1 a95d0bd9bae1f1eb4c84a6ff2807d02f.cloudfront.net (CloudFront)
        X-Amz-Cf-Id: mMtkwKy9h99oKH-1JIcwbwvHLvWcNoGCfM_YhN5jS-ELFytsATtYBA==
        X-Amz-Cf-Pop: ORD52-C1
        X-Amzn-Trace-Id: Root=1-5e84b7df-42b3db8eb60987c763671aa5;Sampled=0
        X-Cache: Miss from cloudfront
        x-amz-apigw-id: KUGq6E5OoAMFZyg=
        x-amzn-RequestId: da9f3bbc-273d-418c-8e9a-eca8ac86c9ad

        []

1. You should also try the other endpoints. The database should be empty at this
point, so all of them will return empty results but they should return with 200s.

    * `/api/usage`
    * `/api/leases`

1. You can use the AWS CLI to get log output and invocation information about the 
AWS Lambda functions to make sure that they ran as expected. For example, to view
the logs by using the command here:

        $ aws logs get-log-events --log-group-name /aws/lambda/accounts-dce-o05cdj7l --log-stream-name '<stream name>' --query "events[*].message" --output text

1. If you want to view the number of invocations, both errors and invocations, you
can use the [AWS CLI](https://aws.amazon.com/premiumsupport/knowledge-center/cloudwatch-getmetricdata-api/) to also do that. As example is shown here:

1. Now that you know the API gateway is properly functioning and the Lambda functions
are not throwing any fatal errors, use the DCE CLI to perform the rest of the tests. 
Start by listing the accounts, which should be still empty:

        $ dce accounts list
        []
        $ dce leases list
        []
        $ dce usage --start-date 1 --end-date `date +%s`
        TODO: an error here

1. Now try to get an account that does not exist to make sure the error is handled 
gracefully (hint: it is _not_, see issue [#50](https://github.com/Optum/dce-cli/issues/50))
This is current behavior, so make sure that it is not changed. Also, the logs should
display a `account "123456789012" not found` message but there should not be any 
errors in the Lambda metrics because a 404 is not a Lambda error

        $ dce accounts describe 123456789012
        err:  unknown error (status 404): {resp:0xc000664000} 
        exit status 1

# UC2: Adding an account

## Preconditions

* All of the steps in Basic Flow 1 have been performed

## Basic Steps

1. Add an account to the pool by typing the following command

        $ dce accounts add --account-id 123456789012 -r 'arn:aws:iam::123456789012:role/DCEAdmin'

## Postconditions

To verify that the add command worked, type the following command:

    $ dce accounts list
    [
        {
                "accountStatus": "NotReady",
                "adminRoleArn": "arn:aws:iam::123456789012:role/DCEAdmin",
                "createdOn": 1585773960,
                "id": "123456789012",
                "lastModifiedOn": 1585773960,
                "principalPolicyHash": "\"2c3aa67c20ef6a935c490da82c7cc862\"",
                "principalRoleArn": "arn:aws:iam::123456789012:role/DCEPrincipal-dce-o05cdj7l"
        }
    ]

# UC3: Account becoming ready

After some amount of time, the account added should transition from "NotReady" to "Ready"
without any additional information

## Preconditions

* Steps in UC2 have been preformed

## Basic Steps

1. Wait for a period of time for the newly-added account to be reset
1. Type the following command:

    $ dce accounts list

## Postconditions

The output should look like this: 

    [
        {
                "accountStatus": "Ready",
                "adminRoleArn": "arn:aws:iam::123456789012:role/DCEAdmin",
                "createdOn": 1585773960,
                "id": "123456789012",
                "lastModifiedOn": 1585774024,
                "principalPolicyHash": "\"2c3aa67c20ef6a935c490da82c7cc862\"",
                "principalRoleArn": "arn:aws:iam::123456789012:role/DCEPrincipal-dce-o05cdj7l"
        }
    ]